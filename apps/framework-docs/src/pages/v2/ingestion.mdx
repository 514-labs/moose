import { Callout } from "../../components";

# Data Ingestion

The `IngestApi` component in Moose provides type-safe HTTP endpoints for data ingestion.

## Basic Usage

```typescript
import { IngestApi, Stream } from '@514labs/moose-lib';

// Define your data type
interface UserEvent {
  id: string;
  userId: string;
  action: string;
  timestamp: Date;
}

// Create a stream for the data
const eventStream = new Stream<UserEvent>("user_events");

// Create the ingestion endpoint
const eventIngestion = new IngestApi<UserEvent>("events", {
  destination: eventStream
});
```

This creates an HTTP endpoint at `/api/ingest/events` that validates incoming data against your type definition.

### `IngestApi` Configuration
```typescript
interface IngestConfig<T> {
  destination: Stream<T>;    // Stream to write incoming data to
  format?: IngestionFormat;  // Data format specification
}
```

## HTTP Endpoints

### Endpoint Configuration
The IngestApi creates a single endpoint at `/api/ingest/<name>` that can be configured to accept either single records or batches using the `format` option:

```typescript
import { IngestApi, Stream, IngestionFormat } from '@514labs/moose-lib';

// Configure for single record ingestion (default)
const singleEventIngestion = new IngestApi<UserEvent>("single_events", {
  destination: eventStream,
  format: IngestionFormat.JSON  // Accept single JSON objects
});

// Configure for batch ingestion
const batchEventIngestion = new IngestApi<UserEvent>("batch_events", {
  destination: eventStream,
  format: IngestionFormat.JSON_ARRAY  // Accept array of JSON objects
});
```

### Using the Endpoints

```bash
# Single record ingestion (IngestionFormat.JSON)
curl -X POST http://localhost:4000/api/ingest/single_events \
  -H "Content-Type: application/json" \
  -d '{
    "id": "123",
    "userId": "user_456",
    "action": "login",
    "timestamp": "2024-03-24T10:30:00Z"
  }'

# Batch ingestion (IngestionFormat.JSON_ARRAY)
curl -X POST http://localhost:4000/api/ingest/batch_events \
  -H "Content-Type: application/json" \
  -d '[
    {
      "id": "123",
      "userId": "user_456",
      "action": "login",
      "timestamp": "2024-03-24T10:30:00Z"
    },
    {
      "id": "124",
      "userId": "user_456",
      "action": "logout",
      "timestamp": "2024-03-24T11:30:00Z"
    }
  ]'
```

## OpenAPI Specification

Moose automatically generates an OpenAPI specification for all ingestion endpoints.

### Accessing the Specification
- Development server: `http://localhost:5001/openapi.yaml`
- Project file: `.moose/openapi.yaml`

### Specification Features
- Complete endpoint documentation
- Request/response schemas
- Type definitions
- Example payloads

### SDK Generation
You can easily generate type-safe clients using the OpenAPI specification and the openapi-generator-cli:

<Callout type="info">
You can install the OpenAPI Generator CLI using npm or Docker:

```bash
npm install -g @openapitools/openapi-generator-cli
```

or

```bash
docker pull openapitools/openapi-generator-cli
```
</Callout>

Then generate the client:

```bash
# Generate TypeScript client
openapi-generator-cli generate \
  -i .moose/openapi.yaml \
  -g typescript-fetch \
  -o ./moose_sdk

# Generate Python client
openapi-generator-cli generate \
  -i .moose/openapi.yaml \
  -g python-requests \
  -o ./moose_sdk
```

## Quick Setup with IngestPipeline

For rapid development, use IngestPipeline to create an ingestion endpoint:

```typescript
const pipeline = new IngestPipeline<UserEvent>("user_events", {
  ingest: true,  // Creates IngestApi endpoint
  stream: true,  // Creates destination stream
  table: true    // Optional: also store data
});
```

This creates the same ingestion endpoints with minimal configuration. 