import { Callout, ZoomImg, ToggleBlock } from "../../components";
import { FileTree } from "nextra/components";

# Define a Data Model to Ingest Data from the Github Webhook

Now you’re ready to define your first Moose primitive: a **Data Model**. This primitive is where you specify the schema of the data you will use in your application. Let's create a `RawStarEvent` Data Model for the data we will receive from the GitHub webhook.

### Initialize a Data Model from Sample Data via the CLI

Instead of creating your Data Model by hand, let’s use the Moose helper function that can automatically generate Data Models based on analyzing a set of sample data.

#### Add Sample Data to your Project

Create a new file named `sample-data.json` in the root folder of your project. Then paste the following sample data into the new file, and save and close:

<ToggleBlock openText="Collapse Sample Data JSON" closeText="Show Sample Data JSON">
```json filename="sample-data.json" copy
[{
  "action": "created",
  "starred_at": "2024-07-30T01:04:06Z",
  "repository": {
    "id": 668493044,
    "node_id": "R_kgDOJ9hk9A",
    "name": "moose",
    "full_name": "514-labs/moose",
    "private": false,
    "owner": {
      "login": "514-labs",
      "id": 140028474,
      "node_id": "O_kgDOCFiqOg",
      "avatar_url": "https://avatars.githubusercontent.com/u/140028474?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/514-labs",
      "html_url": "https://github.com/514-labs",
      "followers_url": "https://api.github.com/users/514-labs/followers",
      "following_url": "https://api.github.com/users/514-labs/following{/other_user}",
      "gists_url": "https://api.github.com/users/514-labs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/514-labs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/514-labs/subscriptions",
      "organizations_url": "https://api.github.com/users/514-labs/orgs",
      "repos_url": "https://api.github.com/users/514-labs/repos",
      "events_url": "https://api.github.com/users/514-labs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/514-labs/received_events",
      "type": "Organization",
      "site_admin": false
    },
    "html_url": "https://github.com/514-labs/moose",
    "description": "The developer framework for your data & analytics stack",
    "fork": false,
    "url": "https://api.github.com/repos/514-labs/moose",
    "forks_url": "https://api.github.com/repos/514-labs/moose/forks",
    "keys_url": "https://api.github.com/repos/514-labs/moose/keys{/key_id}",
    "collaborators_url": "https://api.github.com/repos/514-labs/moose/collaborators{/collaborator}",
    "teams_url": "https://api.github.com/repos/514-labs/moose/teams",
    "hooks_url": "https://api.github.com/repos/514-labs/moose/hooks",
    "issue_events_url": "https://api.github.com/repos/514-labs/moose/issues/events{/number}",
    "events_url": "https://api.github.com/repos/514-labs/moose/events",
    "assignees_url": "https://api.github.com/repos/514-labs/moose/assignees{/user}",
    "branches_url": "https://api.github.com/repos/514-labs/moose/branches{/branch}",
    "tags_url": "https://api.github.com/repos/514-labs/moose/tags",
    "blobs_url": "https://api.github.com/repos/514-labs/moose/git/blobs{/sha}",
    "git_tags_url": "https://api.github.com/repos/514-labs/moose/git/tags{/sha}",
    "git_refs_url": "https://api.github.com/repos/514-labs/moose/git/refs{/sha}",
    "trees_url": "https://api.github.com/repos/514-labs/moose/git/trees{/sha}",
    "statuses_url": "https://api.github.com/repos/514-labs/moose/statuses/{sha}",
    "languages_url": "https://api.github.com/repos/514-labs/moose/languages",
    "stargazers_url": "https://api.github.com/repos/514-labs/moose/stargazers",
    "contributors_url": "https://api.github.com/repos/514-labs/moose/contributors",
    "subscribers_url": "https://api.github.com/repos/514-labs/moose/subscribers",
    "subscription_url": "https://api.github.com/repos/514-labs/moose/subscription",
    "commits_url": "https://api.github.com/repos/514-labs/moose/commits{/sha}",
    "git_commits_url": "https://api.github.com/repos/514-labs/moose/git/commits{/sha}",
    "comments_url": "https://api.github.com/repos/514-labs/moose/comments{/number}",
    "issue_comment_url": "https://api.github.com/repos/514-labs/moose/issues/comments{/number}",
    "contents_url": "https://api.github.com/repos/514-labs/moose/contents/{+path}",
    "compare_url": "https://api.github.com/repos/514-labs/moose/compare/{base}...{head}",
    "merges_url": "https://api.github.com/repos/514-labs/moose/merges",
    "archive_url": "https://api.github.com/repos/514-labs/moose/{archive_format}{/ref}",
    "downloads_url": "https://api.github.com/repos/514-labs/moose/downloads",
    "issues_url": "https://api.github.com/repos/514-labs/moose/issues{/number}",
    "pulls_url": "https://api.github.com/repos/514-labs/moose/pulls{/number}",
    "milestones_url": "https://api.github.com/repos/514-labs/moose/milestones{/number}",
    "notifications_url": "https://api.github.com/repos/514-labs/moose/notifications{?since,all,participating}",
    "labels_url": "https://api.github.com/repos/514-labs/moose/labels{/name}",
    "releases_url": "https://api.github.com/repos/514-labs/moose/releases{/id}",
    "deployments_url": "https://api.github.com/repos/514-labs/moose/deployments",
    "created_at": "2023-07-20T00:23:21Z",
    "updated_at": "2024-07-30T01:04:07Z",
    "pushed_at": "2024-07-30T00:32:38Z",
    "git_url": "git://github.com/514-labs/moose.git",
    "ssh_url": "git@github.com:514-labs/moose.git",
    "clone_url": "https://github.com/514-labs/moose.git",
    "svn_url": "https://github.com/514-labs/moose",
    "homepage": "https://www.moosejs.com",
    "size": 75529,
    "stargazers_count": 28,
    "watchers_count": 28,
    "language": "Rust",
    "has_issues": true,
    "has_projects": true,
    "has_downloads": true,
    "has_wiki": false,
    "has_pages": false,
    "has_discussions": true,
    "forks_count": 6,
    "mirror_url": "https://github.com/514-labs/moose",
    "archived": false,
    "disabled": false,
    "open_issues_count": 351,
    "license": {
      "key": "mit",
      "name": "MIT License",
      "spdx_id": "MIT",
      "url": "https://api.github.com/licenses/mit",
      "node_id": "MDc6TGljZW5zZTEz"
    },
    "allow_forking": true,
    "is_template": false,
    "web_commit_signoff_required": false,
    "topics": [
      "analytics",
      "data",
      "dataengineering",
      "deployment",
      "framework",
      "insights",
      "metrics",
      "python",
      "rust",
      "typescript"
    ],
    "visibility": "public",
    "forks": 6,
    "open_issues": 351,
    "watchers": 28,
    "default_branch": "main"
  },
  "organization": {
    "login": "514-labs",
    "id": 140028474,
    "node_id": "O_kgDOCFiqOg",
    "url": "https://api.github.com/orgs/514-labs",
    "repos_url": "https://api.github.com/orgs/514-labs/repos",
    "events_url": "https://api.github.com/orgs/514-labs/events",
    "hooks_url": "https://api.github.com/orgs/514-labs/hooks",
    "issues_url": "https://api.github.com/orgs/514-labs/issues",
    "members_url": "https://api.github.com/orgs/514-labs/members{/member}",
    "public_members_url": "https://api.github.com/orgs/514-labs/public_members{/member}",
    "avatar_url": "https://avatars.githubusercontent.com/u/140028474?v=4",
    "description": "build and deploy data-intensive apps with ease"
  },
  "sender": {
    "login": "armanjindal",
    "id": 58370547,
    "node_id": "MDQ6VXNlcjU4MzcwNTQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/58370547?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/armanjindal",
    "html_url": "https://github.com/armanjindal",
    "followers_url": "https://api.github.com/users/armanjindal/followers",
    "following_url": "https://api.github.com/users/armanjindal/following{/other_user}",
    "gists_url": "https://api.github.com/users/armanjindal/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/armanjindal/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/armanjindal/subscriptions",
    "organizations_url": "https://api.github.com/users/armanjindal/orgs",
    "repos_url": "https://api.github.com/users/armanjindal/repos",
    "events_url": "https://api.github.com/users/armanjindal/events{/privacy}",
    "received_events_url": "https://api.github.com/users/armanjindal/received_events",
    "type": "User",
    "site_admin": false
    }
  }
]
```
</ToggleBlock>

#### Run the CLI Command

<Callout type="info">
  Start a new terminal session and make sure to navigate back to your project
  directory.
</Callout>
```bash filename="Terminal" copy npx moose-cli data-model init RawStarEvent -s sample-data.json
```

This command will generate a new file named:`RawStarEvent.ts` and place it in the `datamodels` folder of your project.

<FileTree>
  <FileTree.File name="sample-data.json" />
  <FileTree.Folder name="app" open>
    <FileTree.Folder name="datamodels" open>
      <FileTree.File name="RawStarEvent.ts" />
    </FileTree.Folder>
  </FileTree.Folder>
</FileTree>

#### Open and Inspect `RawStarEvent.ts`

Open the file Moose generated for your in your IDE to inspect the Data Model code that was automatically generated from the sample data, noting a couple of interesting fields:

```ts filename="datamodels/RawStarEvent.ts" copy
import { Key } from "@514labs/moose-lib";

export interface RawStarEvent {
  action: Key<string>;
  organization: {
    // more data fields ...
    //..
  };
  // more data fields ...
  // ...
  //...
  sender: {
    //...
  };
  starred_at: string;
}
```

- `action`: Indicates whether a star was `created` or `deleted` for this event.
- `starred_at`: For `created` actions, this field represents the timestamp when the star was added.
- `sender`: An object containing information about the user who starred or un-starred the repository. There are two fields within this nested object that we want to ingest:
  - `sender.login`: the username of the starrer
  - `sender.repos_url`: the URL we can use to lookup the starrer's public repositories

<Callout type="info" title="Data Modeling Tips:">
  - Each Data Model must designate a field as the `Key` type. This special type,
  imported from `@514labs/moose-lib`, specifies the sorting key for your
  Clickhouse table. - The optional (`?`) operator is used to mark a field as
  nullable (*i.e., it's possible for the field to be undefined*). - Only
  **exported interfaces** are picked up as Data Models, and spin up
  corresponding Moose infrastructure.
</Callout>

#### Verify Moose Configured the infrastructure

Your dev server should have automatically picked up on the new Data Model and configured the necessary infrastructure to ingest webhook events with this schema.

Run this command in your terminal to verify:

```bash filename="Terminal"  copy
npx moose-cli ls
```

<Callout type="success">
  With just a single terminal command, you've generated a Moose Data Model. This
  Data Model in turn automatically generated:
  <ul>
    - An API route to ingest `RawStarEvent` data (`ingest/RawStarEvent`) - A
    Redpanda streaming topic to queue and process the data - A Clickhouse
    database table to store these events (`RawStarEvent_0_0`) - A Clickhouse
    database view to query against these events (`RawStarEvent`)
  </ul>
</Callout>
